<!doctype html>
<html lang="">	
<head>
	<meta charset="utf-8"/>
	<title>Snorkeling with Dagger 2 - konmik.github.io</title>	
	<meta name="author" content="Konstantin Mikheev">
	

	<meta name="description" content=""Diving" is too deep and hard. I'm going to teach you quickly and easily. :) Introduction: what the hell is Dagger and how can I benefit from using it? What is Dagger Dagger is a java library that provides an alternative way for objects instantiation. Instead of passing one zillion ...">


	<link rel="top" href="#" /><link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,300italic,400italic,600italic|Source+Code+Pro' rel='stylesheet' type='text/css'></link>
	<link rel="stylesheet" href="./theme/css/main.css" type="text/css" />
		

</head>
	
<body>

    <div class="container">
	  
	  <header role="banner">
	    <div class="feeds">
	    </div>
		<a href="." class="title">konmik.github.io</a>
      </header>
	
	  <div class="wrapper">

		  <div role="main" class="content">
	<article class="full">
			
		<h1>Snorkeling with Dagger 2</h1>
		
<div class="metadata">
  <time datetime="2015-02-01T00:00:00+01:00" pubdate>Sun 01 February 2015</time>
    <address class="vcard author">
      by <a class="url fn" href="./author/konstantin-mikheev.html">Konstantin Mikheev</a>
    </address>
  in <a href="./category/java-android.html">Java, Android</a>
</div>		
		<p>"Diving" is too deep and hard. I'm going to teach you quickly and easily. :)</p>
<h1>Introduction: what the hell is Dagger and how can I benefit from using it?</h1>
<hr />
<h2>What is Dagger</h2>
<p>Dagger is a java library that provides an alternative way for objects instantiation.
Instead of passing one zillion of arguments with constructor you can just
annotate your fields with <code>@Inject</code> annotation and all required objects will be created and assigned automatically.</p>
<div class="highlight"><pre>    <span class="nd">@Inject</span> <span class="n">SharedPreferences</span> <span class="n">pref</span><span class="o">;</span>
</pre></div>


<p>This is done by a source code generation - you annotate some fields, Dagger will create some code that will fill that fields.
You can always check the generated code in the <code>build</code> folder.</p>
<p>Think of Dagger as of a Java language extension. While normally object-oriented languages have a lots of problems with objects creation,
storage and passing them around, Dagger provides an elegant solution.</p>
<h3>History</h3>
<p>Dagger has been developed by <em>Square, Inc</em> guys: <a href="http://square.github.io/dagger/">square.github.io/dagger</a></p>
<p>Dagger 2 is a fork of Square's Dagger that has been developed by <em>Google</em> and has been used on performance critical projects:
<a href="https://github.com/google/dagger">github.com/google/dagger</a></p>
<h2>Singleton</h2>
<p>On Android one of the typical tasks is to create a single <code>SharedPreferences</code> object and share it through all the application.
It is required in an activity, in a fragment, in a custom view. Typical solution is to keep that <code>SharedPreference</code> inside of <code>Application</code> object
and create a getter for it. Then, your code will look like this:</p>
<div class="highlight"><pre><span class="n">SharedPreferences</span> <span class="n">pref</span><span class="o">;</span>
<span class="n">Gson</span> <span class="n">gson</span><span class="o">;</span>
<span class="n">ServerAPI</span> <span class="n">api</span><span class="o">;</span>

<span class="n">onCreate</span><span class="o">(...)</span> <span class="o">{</span>
    <span class="n">MyApp</span> <span class="n">app</span> <span class="o">=</span> <span class="o">(</span><span class="n">MyApp</span><span class="o">)</span><span class="n">getContext</span><span class="o">().</span><span class="na">getApplicationContext</span><span class="o">();</span>
    <span class="n">pref</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="na">getSharedPreferences</span><span class="o">();</span>
    <span class="n">gson</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="na">getGson</span><span class="o">();</span>
    <span class="n">api</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="na">getApi</span><span class="o">();</span>
</pre></div>


<p>One day you will find that <code>MyApp</code> is bloated with stranger things that have no any relevance to <code>MyApp</code>. Or you may find yourself using ugly
Singleton pattern everywhere. Now, think about refactoring. You've decided to move <code>Gson</code> away from <code>MyApp</code> into <code>MyNetwork</code>.
How many lines of code you will need to change?</p>
<p>Dagger way:</p>
<div class="highlight"><pre><span class="nd">@Inject</span> <span class="n">SharedPreferences</span> <span class="n">pref</span><span class="o">;</span>
<span class="nd">@Inject</span> <span class="n">Gson</span> <span class="n">gson</span><span class="o">;</span>
<span class="nd">@Inject</span> <span class="n">ServerAPI</span> <span class="n">api</span><span class="o">;</span>

<span class="n">onCreate</span><span class="o">(...)</span> <span class="o">{</span>
    <span class="n">MainInjector</span><span class="o">.</span><span class="na">inject</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</pre></div>


<p>Now we do not care about where to get all that stuff - it will be created for us. <code>Gson</code> could be inside of <code>MyApp</code> object.
It also could be somewhere in <code>MyNetwork.Parsing.Processor</code>. We just require <code>Gson</code>! Yes, we need to instruct Dagger how to get <code>Gson</code> once,
but later we will be able to share it all over the application with <code>@Inject</code> annotation.</p>
<h2>Order of objects instantiation</h2>
<p>Another problem we have is the order of objects instantiation. Say, we have
<code>ServerAPI</code>, <code>Gson</code>, <code>DateConverter</code>, <code>AuthenticationManager</code>, <code>SharedPreferences</code> and 50 other objects that we need to initialize.
One day we've decided to make some refactoring, and we've lost track of what should be initialized in which order.
Null pointer exceptions everywhere! Stack overflow because of circular constructor calls! What have I done? <code>git reset --hard</code>!
But Dagger manages the order of objects instantiation and warns you about such problems during compile-time.</p>
<h2>Passing constructor arguments that are not required for the object</h2>
<p>How about this example?</p>
<div class="highlight"><pre><span class="n">onCreate</span><span class="o">(..)</span> <span class="o">{</span>
    <span class="n">authManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AuthManager</span><span class="o">(((</span><span class="n">MyApp</span><span class="o">)</span><span class="n">getContext</span><span class="o">().</span><span class="na">getApplicationContext</span><span class="o">()).</span><span class="na">getGson</span><span class="o">());</span>

<span class="n">AuthManager</span><span class="o">(</span><span class="n">Gson</span> <span class="n">gson</span><span class="o">,</span> <span class="n">SharedPreferences</span> <span class="n">pref</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">new</span> <span class="n">Network</span><span class="o">(</span><span class="n">gson</span><span class="o">,</span> <span class="n">pref</span><span class="o">,</span> <span class="n">serverTokenProvider</span><span class="o">);</span>

<span class="n">Network</span><span class="o">(</span><span class="n">Gson</span> <span class="n">gson</span><span class="o">,</span> <span class="n">SharedPreferences</span> <span class="n">pref</span><span class="o">,</span> <span class="n">ServerTokenProvider</span> <span class="n">tokenProvider</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">tokenProvider</span><span class="o">)</span>
    <span class="k">new</span> <span class="n">ServerAPI</span><span class="o">(</span><span class="n">gson</span><span class="o">,</span> <span class="n">pref</span><span class="o">,</span> <span class="n">tokenProvider</span><span class="o">);</span>

<span class="n">ServerAPI</span><span class="o">(</span><span class="n">Gson</span> <span class="n">gson</span><span class="o">,</span> <span class="n">SharedPreferences</span> <span class="n">pref</span><span class="o">,</span> <span class="n">ServerTokenProvider</span> <span class="n">tokenProvider</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">new</span> <span class="n">RestAdapter</span><span class="o">(</span><span class="n">gson</span><span class="o">);</span> <span class="c1">// Finally!</span>
</pre></div>


<p>Dagger way:</p>
<div class="highlight"><pre><span class="kd">class</span> <span class="nc">ServerAPI</span> <span class="o">{</span>
    <span class="nd">@Inject</span> <span class="n">SharedPreferences</span> <span class="n">pref</span><span class="o">;</span>
    <span class="nd">@Inject</span> <span class="n">Gson</span> <span class="n">gson</span><span class="o">;</span>
    <span class="nd">@Inject</span> <span class="n">ServerTokenProvider</span> <span class="n">tokenProvider</span><span class="o">;</span>
</pre></div>


<p>Or even better:</p>
<div class="highlight"><pre><span class="kd">class</span> <span class="nc">ServerAPI</span> <span class="o">{</span>
    <span class="nd">@Inject</span> <span class="n">RestAdapter</span> <span class="n">restAdapter</span><span class="o">;</span>
</pre></div>


<h1>Installation</h1>
<hr />
<p>Dagger consists of two parts - compiler that will generate the injection code and a very little runtime library.</p>
<p>While Dagger 2 is in a SNAPSHOT version, you'll need to download and install it manually. Get it here:</p>
<div class="highlight"><pre>https://oss.sonatype.org/content/repositories/snapshots/com/google/dagger/dagger/2.0-SNAPSHOT/
https://oss.sonatype.org/content/repositories/snapshots/com/google/dagger/dagger-compiler/2.0-SNAPSHOT/
</pre></div>


<p>Put <code>jar</code> files in your <code>libs</code> folder and include them into your <code>gradle.build</code> file like this:</p>
<div class="highlight"><pre>dependencies {
    compile &#39;javax.inject:javax.inject:1&#39;
    compile &#39;javax.annotation:javax.annotation-api:1.2&#39;
    compile files(&#39;libs/dagger-2.0-20150122.022617-13.jar&#39;)
    provided files(&#39;libs/dagger-compiler-2.0-20150122.022637-13-jar-with-dependencies.jar&#39;)
}
</pre></div>


<p>You'll also need to include that two <code>javax.*</code> additional libraries Dagger 2 depends on.</p>
<h1>Basic example</h1>
<hr />
<h2>Simple injection with @Inject constructor</h2>
<p>Let's create a simplest possible example. We will inject <code>PreferencesLogger</code> - an object that will log all <code>SharedPreferences</code> values.</p>
<div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PreferencesLogger</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="kd">public</span> <span class="nf">PreferencesLogger</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">log</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SharedPreferences</span> <span class="n">pref</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getSharedPreferences</span><span class="o">(</span><span class="s">&quot;preferences&quot;</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>

        <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="s">&quot;Logging all preferences:&quot;</span><span class="o">);</span>

        <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">pref</span><span class="o">.</span><span class="na">getAll</span><span class="o">().</span><span class="na">entrySet</span><span class="o">())</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; = &quot;</span> <span class="o">+</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p><code>@Inject</code> says to Dagger that this constructor will be used to instantiate <code>PreferencesLogger</code> object. While current implementation
is quite stupid, we will make <code>SharedPreferences</code> to be passed to the <code>PreferencesLogger</code>'s constructor later and it will look a little bit better.</p>
<h2>Injection</h2>
<p>Here is how we want to use <code>PreferencesLogger</code>:</p>
<div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="o">{</span>
    <span class="nd">@Inject</span> <span class="n">PreferencesLogger</span> <span class="n">logger</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>

        <span class="n">MyApplication</span><span class="o">.</span><span class="na">inject</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>

        <span class="n">logger</span><span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h2>Code generation</h2>
<p>Are you curious how <code>MyApplication.inject</code> looks like? No, you can't see it right now. :D At first you'll need to see a little picture.</p>
<p><img alt="Dagger 2 diagram 1" src="images/dagger_2_diagram_1.png" /></p>
<p>While working with Dagger 2, we need to keep in mind how it is composed. You know about <code>@Inject</code> constructor, so next
thing to know about is <code>@Component</code>. Component is an interface marked with <code>@Component</code> annotation that shows
to Dagger 2 which objects we want to inject into.</p>
<div class="highlight"><pre><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AppComponent</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">inject</span><span class="o">(</span><span class="n">MainActivity</span> <span class="n">activity</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>


<p><code>@Component</code> says to Dagger 2 that it should generate code for injection into <code>MainActivity</code>.</p>
<p>After we wrote all this, we press <code>Build</code> button to make Dagger 2 generate an <code>AppComponent</code> implementation.</p>
<h2>Finally: the injection code</h2>
<div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyApplication</span> <span class="kd">extends</span> <span class="n">Application</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">AppComponent</span> <span class="n">component</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">();</span>
        <span class="n">component</span> <span class="o">=</span> <span class="n">Dagger_AppComponent</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">inject</span><span class="o">(</span><span class="n">MainActivity</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">component</span><span class="o">.</span><span class="na">inject</span><span class="o">(</span><span class="n">target</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p><code>Dagger_AppComponent</code> is a generated class of type <code>AppComponent</code> that we need to access the generated code.</p>
<p>Now we have a complete workable example! :)</p>
<p>Yes, Dagger requires a little bit of work to do at the beginning. But think about advantages it can give!
On my average project I have about 50 objects that need to be shared across an application.
Amount of code rewrites Dagger saves for me is incredible! Before Dagger I always avoided refactoring whenever possible.
Now I refactor quickly and easily, without side-effects or broken connections between objects.</p>
<p>I hope you're still alive at this point. If so, let's study some advanced topics.</p>
<h1>Exploring the generated code</h1>
<hr />
<p>Let's take a look at what has been generated. I've stripped out all code that does nothing, to not bloat this quickie guide. :)</p>
<div class="highlight"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Dagger_AppComponent</span> <span class="kd">implements</span> <span class="n">AppComponent</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">MembersInjector</span> <span class="n">mainActivityMembersInjector</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nf">Dagger_AppComponent</span><span class="o">(</span><span class="n">Builder</span> <span class="n">builder</span><span class="o">)</span> <span class="o">{</span>
<span class="o">(</span><span class="mi">3</span><span class="o">)</span>     <span class="n">initialize</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Builder</span> <span class="nf">builder</span><span class="o">()</span> <span class="o">{</span>
<span class="o">(</span><span class="mi">1</span><span class="o">)</span>    <span class="k">return</span> <span class="k">new</span> <span class="n">Builder</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">()</span> <span class="o">{</span>
<span class="o">(</span><span class="mi">4</span><span class="o">)</span>    <span class="k">this</span><span class="o">.</span><span class="na">mainActivityMembersInjector</span> <span class="o">=</span> <span class="n">MainActivity$$MembersInjector</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">MembersInjectors</span><span class="o">.</span><span class="na">noOp</span><span class="o">(),</span> <span class="n">PreferencesLogger$$Factory</span><span class="o">.</span><span class="na">create</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">inject</span><span class="o">(</span><span class="n">MainActivity</span> <span class="n">activity</span><span class="o">)</span> <span class="o">{</span>
<span class="o">(</span><span class="mi">9</span><span class="o">)</span>   <span class="n">mainActivityMembersInjector</span><span class="o">.</span><span class="na">injectMembers</span><span class="o">(</span><span class="n">activity</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Builder</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="n">AppComponent</span> <span class="nf">build</span><span class="o">()</span> <span class="o">{</span>
<span class="o">(</span><span class="mi">2</span><span class="o">)</span>        <span class="k">return</span> <span class="k">new</span> <span class="n">Dagger_AppComponent</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">MainActivity$$MembersInjector</span> <span class="kd">implements</span> <span class="n">MembersInjector</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">MembersInjector</span> <span class="n">supertypeInjector</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Provider</span> <span class="n">loggerProvider</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">MainActivity$$MembersInjector</span><span class="o">(</span><span class="n">MembersInjector</span> <span class="n">supertypeInjector</span><span class="o">,</span> <span class="n">Provider</span> <span class="n">loggerProvider</span><span class="o">)</span> <span class="o">{</span>
<span class="o">(</span><span class="mi">7</span><span class="o">)</span>     <span class="k">this</span><span class="o">.</span><span class="na">supertypeInjector</span> <span class="o">=</span> <span class="n">supertypeInjector</span><span class="o">;</span>
<span class="o">(</span><span class="mi">8</span><span class="o">)</span>     <span class="k">this</span><span class="o">.</span><span class="na">loggerProvider</span> <span class="o">=</span> <span class="n">loggerProvider</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">injectMembers</span><span class="o">(</span><span class="n">MainActivity</span> <span class="n">instance</span><span class="o">)</span> <span class="o">{</span>
<span class="o">(</span><span class="mi">10</span><span class="o">)</span>   <span class="n">supertypeInjector</span><span class="o">.</span><span class="na">injectMembers</span><span class="o">(</span><span class="n">instance</span><span class="o">);</span>
<span class="o">(</span><span class="mi">11</span><span class="o">)</span>   <span class="n">instance</span><span class="o">.</span><span class="na">logger</span> <span class="o">=</span> <span class="n">loggerProvider</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">MembersInjector</span> <span class="nf">create</span><span class="o">(</span><span class="n">MembersInjector</span> <span class="n">supertypeInjector</span><span class="o">,</span> <span class="n">Provider</span> <span class="n">loggerProvider</span><span class="o">)</span> <span class="o">{</span>
<span class="o">(</span><span class="mi">6</span><span class="o">)</span>  <span class="k">return</span> <span class="k">new</span> <span class="n">MainActivity$$MembersInjector</span><span class="o">(</span><span class="n">supertypeInjector</span><span class="o">,</span> <span class="n">loggerProvider</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">enum</span> <span class="n">PreferencesLogger$$Factory</span> <span class="kd">implements</span> <span class="n">Factory</span> <span class="o">{</span>
    <span class="n">INSTANCE</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">PreferencesLogger</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span>
<span class="o">(</span><span class="mi">12</span><span class="o">)</span>   <span class="k">return</span> <span class="k">new</span> <span class="n">PreferencesLogger</span><span class="o">();</span> <span class="c1">// @Inject annotated constructor call</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Factory</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
<span class="o">(</span><span class="mi">5</span><span class="o">)</span>    <span class="k">return</span> <span class="n">INSTANCE</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>No comments has been generated but it is quite obvious how this simple code works.
I'll just put here some referenced code that can confuse by its absence.</p>
<div class="highlight"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Factory</span>  <span class="kd">extends</span> <span class="n">javax</span><span class="o">.</span><span class="na">inject</span><span class="o">.</span><span class="na">Provider</span> <span class="o">{</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Provider</span>  <span class="o">{</span>
    <span class="n">T</span> <span class="nf">get</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MembersInjector</span>  <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">injectMembers</span><span class="o">(</span><span class="n">T</span> <span class="n">t</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span>  <span class="n">MembersInjector</span> <span class="nf">noOp</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">MembersInjector</span><span class="o">)</span> <span class="n">NoOpMembersInjector</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="kd">enum</span> <span class="n">NoOpMembersInjector</span> <span class="kd">implements</span> <span class="n">MembersInjector</span> <span class="o">{</span>
    <span class="n">INSTANCE</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">injectMembers</span><span class="o">(</span><span class="n">Object</span> <span class="n">instance</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>How you have a little task to do: trace visually all steps that will be made by executing this code:</p>
<div class="highlight"><pre>    <span class="n">Dagger_AppComponent</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">build</span><span class="o">().</span><span class="na">inject</span><span class="o">(</span><span class="n">MainActivity</span><span class="o">.</span><span class="na">this</span><span class="o">);</span>
</pre></div>


<p>What is going on here?</p>
<ul>
<li><code>Builder</code> creates <code>Dagger_AppComponent</code>;</li>
<li><code>Dagger_AppComponent</code> creates <code>MainActivity$$MembersInjector</code>;</li>
<li><code>MainActivity$$MembersInjector</code> uses <code>PreferencesLogger$$Factory</code> to instantiate <code>PreferencesLogger</code> and injects it into <code>MainActivity</code>.</li>
</ul>
<p>OK, at this point you should understand the basics of how Dagger 2 works, it is time to drink some tea. Take a break and continue 15 minutes later. :D</p>
<h1>Injection of third-party classes</h1>
<hr />
<h2>Module definition</h2>
<p>Let's create our next example around sharing a <code>SharedPreferences</code> object.
At first, we need to somehow say to Dagger how we want to instantiate <code>SharedPreferences</code>.
We obviously can not mark it's constructor with <code>@Inject</code>, so we do this by creation <strong>Module</strong> object like this:</p>
<div class="highlight"><pre><span class="nd">@Module</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AppModule</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">PREFERENCES_FILE_NAME</span> <span class="o">=</span> <span class="s">&quot;preferences&quot;</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">MyApplication</span> <span class="n">app</span><span class="o">;</span>

    <span class="n">AppModule</span><span class="o">(</span><span class="n">MyApplication</span> <span class="n">app</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">app</span> <span class="o">=</span> <span class="n">app</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Singleton</span>
    <span class="nd">@Provides</span>
    <span class="n">SharedPreferences</span> <span class="nf">provideSharedPreferences</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">app</span><span class="o">.</span><span class="na">getSharedPreferences</span><span class="o">(</span><span class="n">PREFERENCES_FILE_NAME</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p><code>@Module</code> says to Dagger that this object will be used for objects instantiation.</p>
<p>You can have any number of modules, for example you can create <code>DatabaseModule</code>, <code>NetworkModule</code>, <code>MainActivityModule</code>, etc.
I would recommend to think of module as a part of your application that <em>provides</em> some functionality,
 while <code>Component</code> is a part of your application that <em>consumes</em> some functionality.</p>
<p><code>@Provides</code> means that this method should be called to instantiate an object.</p>
<p><code>@Singleton</code> means that the object should be reused for injection into other objects.</p>
<p>Here is a little diagram of how <strong>Module</strong> is being used by Dagger 2:</p>
<p><img alt="Dagger 2 diagram 2" src="images/dagger_2_diagram_2.png" /></p>
<h2>New <code>PreferencesLogger</code></h2>
<p>Now we do not want to instantiate <code>SharedPreferences</code> inside of <code>PreferencesLogger</code>,
now we can declare it in the <code>PreferencesLogger</code>'s constructor and Dagger will supply
constructor with <code>SharedPreferences</code> instance.</p>
<div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PreferencesLogger</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">SharedPreferences</span> <span class="n">pref</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="kd">public</span> <span class="nf">PreferencesLogger</span><span class="o">(</span><span class="n">SharedPreferences</span> <span class="n">pref</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">pref</span> <span class="o">=</span> <span class="n">pref</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">log</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="s">&quot;Logging all preferences:&quot;</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">pref</span><span class="o">.</span><span class="na">getAll</span><span class="o">().</span><span class="na">entrySet</span><span class="o">())</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; = &quot;</span> <span class="o">+</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h2>New <code>AppComponent</code></h2>
<div class="highlight"><pre><span class="nd">@Singleton</span>
<span class="nd">@Component</span><span class="o">(</span><span class="n">modules</span> <span class="o">=</span> <span class="n">AppModule</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AppComponent</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">inject</span><span class="o">(</span><span class="n">MainActivity</span> <span class="n">activity</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>


<p><code>@Singleton</code> says that this component will keep singleton instances.</p>
<p><code>(modules = AppModule.class)</code> means that AppModule will be used for injections by AppComponent. You can enumerate several modules here.</p>
<h2>New <code>AppComponent</code> instantiation</h2>
<div class="highlight"><pre>    <span class="n">component</span> <span class="o">=</span> <span class="n">Dagger_AppComponent</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">appModule</span><span class="o">(</span><span class="k">new</span> <span class="n">AppModule</span><span class="o">(</span><span class="k">this</span><span class="o">)).</span><span class="na">build</span><span class="o">();</span>
</pre></div>


<p>That's it. Now you know how to use third-party objects with Dagger 2.</p>
<h1>Magic</h1>
<hr />
<h2>Easier instantiation of Component</h2>
<p>If you've tried to use Dagger 2, then you've noticed that IDE can not find <code>Dagger_AppComponent</code> and marks it as error
with red color while the project still compiles without errors. Everything should look nice and clean,
so this issue should be somehow avoided.</p>
<p>While surfing GitHub I've found an interesting solution for this problem. Here is the link:
<a href="a href=&quot;https://github.com/square/mortar/blob/master/dagger2support/src/main/java/mortar/dagger2support/Dagger2.java">Dagger2.java</a></p>
<p>I would recommend this method. It uses reflection, but it does not create any noticeable performance impact.
On a slowest device that I could get it takes just about 10 ms during application startup time.</p>
<h2>Easier injection + inheritance</h2>
<p>One option of how to make injection easier is to change a little bit our injection method.
Instead of writing <code>MyApplication.inject(...)</code> we could write <code>MyApplication.getComponent().inject(...)</code>
so we do not need to bloat <code>MyApplication</code>.</p>
<p>Another option relies on reflection, so I will describe it more verbosely.</p>
<p>During good old times of Dagger 1 we had only one <code>void inject(Object object)</code> method.
While it was not so blazing fast it was quite handy. In example, we could write <code>inject(this)</code> in a base class
and all subclasses would get their injections without additional Dagger calls.
It was so handy, so I decided to reproduce such behaviour.</p>
<p>Here is example:</p>
<div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BaseTarget</span> <span class="o">{</span>
    <span class="nd">@Inject</span> <span class="kd">protected</span> <span class="n">MyApplication</span> <span class="n">app</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">BaseTarget</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="s">&quot;app before injection: &quot;</span> <span class="o">+</span> <span class="n">app</span><span class="o">);</span>
        <span class="n">MyApplication</span><span class="o">.</span><span class="na">getComponent</span><span class="o">().</span><span class="na">inject</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="s">&quot;app after injection: &quot;</span> <span class="o">+</span> <span class="n">app</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>To satisfy this dependency I will just add this code to <code>AppModule</code>:</p>
<div class="highlight"><pre><span class="nd">@Provides</span>
<span class="n">MyApplication</span> <span class="nf">provideApp</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">app</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>


<p>A subclass that should get injection without direct <code>inject(...)</code> call:</p>
<div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RealTarget</span> <span class="kd">extends</span> <span class="n">BaseTarget</span> <span class="o">{</span>
    <span class="nd">@Inject</span> <span class="n">SharedPreferences</span> <span class="n">pref</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">RealTarget</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">check</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="s">&quot;Base injection app: &quot;</span> <span class="o">+</span> <span class="n">app</span><span class="o">);</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="s">&quot;Real injection pref: &quot;</span> <span class="o">+</span> <span class="n">pref</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>Calling <code>new RealTarget().check()</code> produces the following output:</p>
<div class="highlight"><pre>app before injection: null
app after injection: info.android15.dagger2example.MyApplication@419412e0
Base injection app: info.android15.dagger2example.MyApplication@419412e0
Real injection pref: null
</pre></div>


<p>As you can see, subclass dependency <code>SharedPreferences</code> has not been satisfied because the classical
Dagger 2 usage pattern implies that you should call <code>inject(...)</code> on a <code>RealTarget</code>.
If you're like to create things like <code>BaseActivity</code>, <code>BaseCustomView</code>, <code>BaseAdapter</code>, etc, this can not be satisfying.</p>
<p>Now I will use that reflection code I'm talking about
<a href="https://github.com/konmik/Dagger2Example/blob/master/app/src/main/java/info/android15/dagger2example/Dagger2Helper.java">Dagger2Helper</a>:</p>
<div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyApplication</span> <span class="kd">extends</span> <span class="n">Application</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">AppComponent</span> <span class="n">component</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">();</span>
        <span class="c1">// component = Dagger_AppComponent.builder().appModule(new AppModule(this)).build();</span>
        <span class="n">component</span> <span class="o">=</span> <span class="n">Dagger2Helper</span><span class="o">.</span><span class="na">buildComponent</span><span class="o">(</span><span class="n">AppComponent</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">AppModule</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">inject</span><span class="o">(</span><span class="n">Object</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Dagger2Helper</span><span class="o">.</span><span class="na">inject</span><span class="o">(</span><span class="n">AppComponent</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">component</span><span class="o">,</span> <span class="n">target</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BaseTarget</span> <span class="o">{</span>
    <span class="nd">@Inject</span> <span class="kd">protected</span> <span class="n">MyApplication</span> <span class="n">app</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">BaseTarget</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="s">&quot;app before injection: &quot;</span> <span class="o">+</span> <span class="n">app</span><span class="o">);</span>
        <span class="c1">// MyApplication.getComponent().inject(this);</span>
        <span class="n">MyApplication</span><span class="o">.</span><span class="na">inject</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="s">&quot;app after injection: &quot;</span> <span class="o">+</span> <span class="n">app</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>Output:</p>
<div class="highlight"><pre>app before injection: null
app after injection: info.android15.dagger2example.MyApplication@419430e0
Base injection app: info.android15.dagger2example.MyApplication@419430e0
Real injection pref: android.app.SharedPreferencesImpl@419630d8
</pre></div>


<p>Hurray! Easy injections through a base class! Yeh, but what is their price?
I said "reflection" so I need to prove that it will not degrade the performance.</p>
<h2>Performance</h2>
<p>For performance benchmarks I've used Galaxy S - an android device of year 2010. I've also created 50-method Component class to make reflection run slower.</p>
<p>A direct injection on a subclass takes 0.0013 ms,
a reflected injection on a superclass takes 0.014 ms.
Both prices are negligible.</p>
<p>For a comparison, one frame of 60 FPS animation takes 16 ms. You can make 100 reflected injections or 1000 direct injections
EVERY frame during the scroll time and the user will never see the difference even on a slowest device.
Typically we do not inject during scrolling - this is something we do during loading, so we can consider Dagger 2 injection to be free.</p>
<h1>Example code</h1>
<hr />
<p>Example code is available at <a href="https://github.com/konmik/Dagger2Example">GitHub/konmik/Dagger2Example</a></p>	

	</article>

<hr />

<h2>Comments Section</h2>
<p>Feel free to comment on the post.</p>

    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'konmik'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
		  </div>	

		  <div class="sidebar">

	        <nav>
	          <h2>Categories</h2>
	          <ul>
	              <li class="active"><a href="./category/java-android.html">Java, Android</a></li>
	          </ul>
	        </nav>


	          <aside>
	            <h2>Links</h2>
	            <ul>
	                <li><a href="https://github.com/konmik">GitHub</a></li>
	            </ul>
	          </aside>

		  </div>

	  </div>

      <footer>
		<p role="contentinfo">
		  Â© 2013 Konstantin Mikheev - Proudly powered by <a href="http://alexis.notmyidea.org/pelican/">pelican</a>. Theme <a href="https://github.com/fle/pelican-simplegrey">pelican-simplegrey</a>.
    	</p>

	  </footer>	

	</div>
	

</body>
</html>